/*! (C) 2016 Conviva, Inc. All rights reserved. Confidential and proprietary. */
Conviva.Impl=Conviva.Impl||{},Conviva.Impl.Html5PlayerInterface=function(a,b,c){function d(a,b){if(this._log("Html5PlayerInterface._constr()"),!a)throw new Error("Html5PlayerInterface: playerStateManager argument cannot be null.");
if(!b)throw new Error("Html5PlayerInterface: videoElement argument cannot be null.");this._playerStateManager=a,this._videoElement=b,this._eventListeners=[],this._registerVideoEventListeners(),this._resetPlayHeadTimes(),
this._resetTimeupdate(),this._startPolling(),this._findCurrentState(),this._playerStateManager.setClientMeasureInterface(this),this._playerStateManager.setModuleNameAndVersion("HTML5",Conviva.Client.version);
}var e=this,f=500,g=4e3/f,h=2e3/f,i=1,j=0,k=.25;e._lastPlayHeadTimeSpeeds=[],e._timeupdate=0,e._lastTimeupdate=0,e._currentTimeIsInvalid=!1,this._timerInterface=new Conviva.Impl.Html5Timer,this._loggingInterface=c.buildLogger(),
this._loggingInterface.setModuleName("Html5PlayerInterface"),this._width=-1,this._height=-1,this._addEventListener=function(a,b,c){"undefined"==typeof c&&(c=e._videoElement),e._eventListeners.push([a,b,c]),
window.addEventListener?c.addEventListener(a,b,!1):c.attachEvent("on"+a,b)},this._removeEventListener=function(a,b,c){"undefined"==typeof c&&(c=e._videoElement),window.removeEventListener?c.removeEventListener(a,b,!1):c.detachEvent("on"+a,b);
},this._registerVideoEventListeners=function(){e._addEventListener("ended",function(){e._receivedHtml5Event("ended")}),e._addEventListener("pause",function(){e._receivedHtml5Event("pause")}),e._addEventListener("playing",function(){
return 0==e._videoElement.currentTime?void(e._currentTimeIsInvalid=!0):void(e._videoElement.seeking||e._receivedHtml5Event("playing"))}),e._addEventListener("waiting",function(){e._receivedHtml5Event("waiting");
}),e._addEventListener("timeupdate",function(){e._currentTimeIsInvalid&&(e._timeupdate++,e._playerStateManager.getPlayerState()===Conviva.PlayerStateManager.PlayerState.PLAYING||e._videoElement.seeking||e._receivedHtml5Event("playing"));
}),e._addEventListener("error",function(){if(e._videoElement.error){var a=e._videoElement.error.code;e._reportHtml5Error(a)}}),e._addEventListener("loadedmetadata",e._loadedMetadata),e._addEventListener("seeking",function(){
e.isSeekStarted||(e.isSeekStarted=!0,e._playerStateManager.setPlayerSeekStart(-1)),e._currentTimeIsInvalid&&e._playerStateManager.getPlayerState()!==Conviva.PlayerStateManager.PlayerState.BUFFERING&&(e._log("Adjusting Conviva player state to: BUFFERING"),
e._receivedHtml5Event("waiting"))}),e._addEventListener("seeked",function(){e.isSeekStarted=!1,e._playerStateManager.setPlayerSeekEnd()}),e._monitorErrorsFromSourceElements()},this.getPHT=function(){return 1e3*e._videoElement.currentTime;
},this.getBufferLength=function(){var a=e._videoElement.buffered;if(void 0!==a){for(var b=0,c=0;c<a.length;c++){var d=a.start(c),f=a.end(c);d<=e._videoElement.currentTime&&e._videoElement.currentTime<f&&(b+=f-e._videoElement.currentTime);
}return e._currentBufferLength=b,1e3*e._currentBufferLength}},this.getSignalStrength=function(){return Conviva.PlayerStateManager.DEFAULT_SIGNAL_STRENGTH},this.getRenderedFrameRate=function(){return Conviva.PlayerStateManager.DEFAULT_RENDERED_FRAME_RATE;
},this._monitorErrorsFromSourceElements=function(){if("undefined"!=typeof e._videoElement.children){var a=function(){e._log("Caught non-specific error from <source> element, reporting as ERR_UNKNOWN"),
e._reportHtml5Error(0)};e._videoElement._sources=e._videoElement.children;for(var b=0;b<e._videoElement._sources.length;b++){var c=e._videoElement._sources[b];"SOURCE"==c.tagName&&e._addEventListener("error",a,c);
}}},this._removeVideoEventHandlers=function(){for(var a=0;a<e._eventListeners.length;a++){var b=e._eventListeners[a];e._removeEventListener(b[0],b[1],b[2])}e._eventListeners=[]},this._findCurrentState=function(){
e._prevReadyState=e._videoElement.readyState,0===e._videoElement.readyState?e._updateConvivaPlayerState(Conviva.PlayerStateManager.PlayerState.STOPPED):e._videoElement.ended?e._updateConvivaPlayerState(Conviva.PlayerStateManager.PlayerState.STOPPED):(e._videoElement.paused||e._videoElement.seeking)&&e._updateConvivaPlayerState(Conviva.PlayerStateManager.PlayerState.PAUSED),
e._videoElement.readyState>=e._videoElement.HAVE_METADATA&&e._loadedMetadata()},this._receivedHtml5Event=function(a){var b=e._convertHtml5EventToConvivaPlayerState(a);e._log("Received HTML5 event: "+a+". Mapped to Conviva player state: "+b),
e._updateConvivaPlayerState(b)},this._updateConvivaPlayerState=function(a){e._playerStateManager.getPlayerState()!==a&&(e._log("Changing Conviva player state to: "+a),e._playerStateManager.setPlayerState(a),
e._resetPlayHeadTimes(),e._playerStateRecentlyChanged=!0)},this._convertHtml5EventToConvivaPlayerState=function(a){switch(a){case"playing":return Conviva.PlayerStateManager.PlayerState.PLAYING;case"waiting":
return Conviva.PlayerStateManager.PlayerState.BUFFERING;case"ended":case"stopped":return Conviva.PlayerStateManager.PlayerState.STOPPED;case"pause":return Conviva.PlayerStateManager.PlayerState.PAUSED;default:
return Conviva.PlayerStateManager.PlayerState.UNKNOWN}},this._reportHtml5Error=function(a){var b;switch(a){case 1:b="MEDIA_ERR_ABORTED";break;case 2:b="MEDIA_ERR_NETWORK";break;case 3:b="MEDIA_ERR_DECODE";
break;case 4:b="MEDIA_ERR_SRC_NOT_SUPPORTED";break;default:b="MEDIA_ERR_UNKNOWN"}e._log("Reporting error: code="+a+" message="+b);var c=Conviva.Client.ErrorSeverity.FATAL;e._playerStateManager.sendError(b,c);
},this._loadedMetadata=function(){var a=e._videoElement.duration;isNaN(a)||a==1/0||e._playerStateManager.setDuration(a);var b=e._videoElement.videoWidth;!isNaN(b)&&b>=0&&e._playerStateManager.setVideoResolutionWidth(b);
var c=e._videoElement.videoHeight;!isNaN(c)&&c>=0&&e._playerStateManager.setVideoResolutionHeight(c)},this._startPolling=function(){this._previousPosition=0,this._currentPosition=0,this._currentBufferLength=0,
this._pollingTimerCancel=this._timerInterface.createTimer(this._poll,500,"Html5PlayerInterface._poll()")},this._poll=function(){e._pollStreamerResolution(),e._pollPosition(),e._inferPlayerStateFromPosition();
},this._pollStreamerResolution=function(){var a=e._videoElement.videoWidth;!isNaN(a)&&a>=0&&a!=e._width&&(e._playerStateManager.setVideoResolutionWidth(a),e._width=a);var b=e._videoElement.videoHeight;!isNaN(b)&&b>=0&&b!=e._height&&(e._playerStateManager.setVideoResolutionHeight(b),
e._height=b)},this._pollPosition=function(){if(e._previousPosition=e._currentPosition,e._currentPosition=e._videoElement.currentTime,now=Date.now(),e._lastPollTime>0&&now>e._lastPollTime){var a=e._currentPosition-e._previousPosition;
0>a&&(a=0),currentPhtSpeed=a/(now-e._lastPollTime)*1e3,e._lastPlayHeadTimeSpeeds.push(currentPhtSpeed)}e._lastPollTime=now,e._lastPlayHeadTimeSpeeds.length>Math.max(g,h)&&e._lastPlayHeadTimeSpeeds.shift();
},this._inferPlayerStateFromPosition=function(){var a=e._lastPlayHeadTimeSpeeds.length;if(a>=Math.min(h,g)){for(var b=0,c=e._lastPlayHeadTimeSpeeds.slice(),d=0;d<c.length;d++){var f=c[d];b+=f}b/=a;var l=i,m=k,n=e._videoElement.playbackRate;
!isNaN(n)&&n!=1/0&&n>0&&(isSafari=Object.prototype.toString.call(window.HTMLElement).indexOf("Constructor")>0,isSafari&&.5>n&&(n=.5),l*=n,m*=n);var o=e._playerStateManager.getPlayerState();if(o!=Conviva.PlayerStateManager.PlayerState.PLAYING&&a>=h&&Math.abs(b-l)<m)return e._log("Adjusting Conviva player state to: PLAYING"),
void e._updateConvivaPlayerState(Conviva.PlayerStateManager.PlayerState.PLAYING);if(o==Conviva.PlayerStateManager.PlayerState.PLAYING&&a>=g&&b==j)return void(e._videoElement.paused?o!=Conviva.PlayerStateManager.PlayerState.PAUSED&&(e._log("Adjusting Conviva player state to: PAUSED"),
e._updateConvivaPlayerState(Conviva.PlayerStateManager.PlayerState.PAUSED)):e._videoElement.seeking||(e._log("Adjusting Conviva player state to: BUFFERING"),e._updateConvivaPlayerState(Conviva.PlayerStateManager.PlayerState.BUFFERING)));
if(e._currentTimeIsInvalid)return void(e._videoElement.paused?(o!=Conviva.PlayerStateManager.PlayerState.PAUSED&&(e._log("Adjusting Conviva player state to: PAUSED"),e._updateConvivaPlayerState(Conviva.PlayerStateManager.PlayerState.PAUSED)),
e._timeupdate=e._lastTimeupdate):e._videoElement.seeking||(e._timeupdate>1&&e._timeupdate==e._lastTimeupdate&&(e._log("Adjusting Conviva player state to: BUFFERING"),e._updateConvivaPlayerState(Conviva.PlayerStateManager.PlayerState.BUFFERING)),
e._lastTimeupdate=e._timeupdate))}},this._stopPolling=function(){this._pollingTimerCancel()},this._resetPlayHeadTimes=function(){e._lastPlayHeadTimeSpeeds=[],e._previousPosition=-1,e._lastPollTime=0},this._resetTimeupdate=function(){
e._lastTimeupdate=0,e._timeupdate=0},this._log=function(a){this._loggingInterface.log(a,Conviva.SystemSettings.LogLevel.DEBUG)},d.apply(this,arguments),this.cleanup=function(){this._log("Html5PlayerInterface.cleanup()"),
this._stopPolling(),this._removeVideoEventHandlers(),this._videoElement=null,this._playerStateManager=null}},Conviva.Impl=Conviva.Impl||{},Conviva.Impl.Html5Http=function(){function a(){}a.apply(this,arguments),
this.makeRequest=function(a,b,c,d,e,f){return this.makeRequestStandard.apply(this,arguments)},this.makeRequestStandard=function(a,b,c,d,e,f){var g=new XMLHttpRequest;return g.open(a,b,!0),d&&g.overrideMimeType&&(g.overrideMimeType=d),
d&&g.setRequestHeader&&g.setRequestHeader("Content-Type",d),e>0&&(g.timeout=e,g.ontimeout=function(){g.ontimeout=g.onreadystatechange=null,f&&f(!1,"timeout after "+e+" ms")}),g.onreadystatechange=function(){
4===g.readyState&&(g.ontimeout=g.onreadystatechange=null,200==g.status?f&&f(!0,g.responseText):f&&f(!1,"http status "+g.status))},g.send(c),null},this.release=function(){}},Conviva.Impl=Conviva.Impl||{},
Conviva.Impl.Html5Logging=function(){function a(){}a.apply(this,arguments),this.consoleLog=function(a,b){"undefined"!=typeof console&&(console.log&&b===Conviva.SystemSettings.LogLevel.DEBUG||b===Conviva.SystemSettings.LogLevel.INFO?console.log(a):console.warn&&b===Conviva.SystemSettings.LogLevel.WARNING?console.warn(a):console.error&&b===Conviva.SystemSettings.LogLevel.ERROR&&console.error(a));
},this.release=function(){}},Conviva.Impl=Conviva.Impl||{},Conviva.Impl.Html5Metadata=function(){function a(){}a.apply(this,arguments),this.getBrowserName=function(){return null},this.getBrowserVersion=function(){
return null},this.getDeviceBrand=function(){return null},this.getDeviceManufacturer=function(){return null},this.getDeviceModel=function(){return null},this.getDeviceType=function(){return null},this.getDeviceVersion=function(){
return null},this.getFrameworkName=function(){return"HTML5"},this.getFrameworkVersion=function(){return null},this.getOperatingSystemName=function(){return null},this.getOperatingSystemVersion=function(){
return null},this.getDeviceCategory=function(){return null},this.release=function(){}},Conviva.Impl=Conviva.Impl||{},Conviva.Impl.Html5Storage=function(){function a(){}a.apply(this,arguments),this.saveData=function(a,b,c,d){
var e=a+"."+b;try{localStorage.setItem(e,c),d(!0,null)}catch(f){d(!1,f.toString())}},this.loadData=function(a,b,c){var d=a+"."+b;try{var e=localStorage.getItem(d);c(!0,e)}catch(f){c(!1,f.toString())}},
this.release=function(){}},Conviva.Impl=Conviva.Impl||{},Conviva.Impl.Html5Time=function(){function a(){}a.apply(this,arguments),this.getEpochTimeMs=function(){var a=new Date;return a.getTime()},this.release=function(){};
},Conviva.Impl=Conviva.Impl||{},Conviva.Impl.Html5Timer=function(){function a(){}a.apply(this,arguments),this.createTimer=function(a,b,c){var d=setInterval(a,b),e=function(){-1!==d&&(clearInterval(d),d=-1);
};return e},this.release=function(){}};